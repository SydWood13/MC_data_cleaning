---
title: "Pilot_Cleaning"
author: "Xinhui Zhang"
date: "2024-08-08"
output: html_document
---

```{r}
library(tidycode)
library(tibble)
library(dplyr)
library(tidyverse)
library(readr)
library(ggplot2)
```


```{r}
data <- read.csv("Pilot_demographic_data.csv")
```


## randomly assign the number to each person after you used SID to clean the dataset

```{r}
dem_summer_raw <- data %>% select("sis_id", contains(".."))
```

## Rename the data
```{r}
colnames(dem_summer_raw) <- c("SID", "consent", "age", "year", "gender", "first_language", "exp_eng", "confidence", "ethcity", "f_education", "m_education", "lunch_program", "Grant", "Transfer")
```

## consent
```{r}
dem_summer_short <- dem_summer_raw %>%
  mutate(consent = case_when(
    grepl("I do not consent", consent, fixed = TRUE) ~ 0,
    grepl("I consent to participate", consent, fixed = TRUE) ~ 1,
    TRUE ~ 0))
```

##filter
```{r}
dem_summer_short <- dem_summer_short %>%
  filter(consent == 1)
```




## age

dem_summer_clean <- dem_summer_short %>%
  mutate(age = str_remove_all(age, "years old")) %>%
  mutate(age = case_when(
    grepl("I am 20", age, fixed = TRUE) ~ "20",
    grepl("21 years of age at the time of this study", age, fixed = TRUE) ~ "21",
    TRUE ~ age
  ))


##age#2
```{r}
dem_summer_clean <- dem_summer_short %>%
  mutate(age = str_remove_all(age, "[[:space:]]|[[:punct:]]|years old|I am|years of age at the time of this study")) %>% mutate_at(3,as.numeric)

```

## year
```{r}
dem_summer_clean <- dem_summer_clean %>%
  mutate(year = case_when(
    grepl("1st", year, fixed = TRUE) ~ 1,
     grepl("2nd", year, fixed = TRUE) ~ 2,
     grepl("3rd", year, fixed = TRUE) ~ 3,
     grepl("4th", year, fixed = TRUE) ~ 4,
  ))
```


##gender
```{r}
dem_summer_clean <- dem_summer_clean %>%
  mutate(gender = case_when(
    grepl("Woman", gender, fixed = TRUE) ~ 'Woman',
    grepl("Man", gender, fixed = TRUE) ~ 'Man',
    grepl("Non-binary or Genderqueer", gender, fixed = TRUE) ~ 'Other',
    TRUE~NA
  ))
```

##first_language
```{r}
dem_summer_clean <- dem_summer_clean %>%
  mutate(first_language = case_when(
    grepl("English is my first language", first_language, fixed = TRUE) ~ 1,
    grepl("English is not my first language", first_language, fixed = TRUE) ~ 0,
    TRUE~NA
  ))
```

## exp_eng
```{r}
dem_summer_clean <- dem_summer_clean%>%
  mutate(exp_eng = case_when(
    grepl("Some of my education has been in English", exp_eng, fixed = TRUE) ~ 1,
    grepl("About half of my education has been in English", exp_eng, fixed = TRUE) ~ 2,
    grepl("Most of my education has been in English", exp_eng, fixed = TRUE) ~ 3,
    grepl("All or almost all of my academic experience has been in English", exp_eng, fixed = TRUE) ~ 4,
    TRUE ~ NA
  ))
```


## confidence
```{r}
dem_summer_clean <- dem_summer_clean%>%
  mutate(confidence = case_when(
    grepl("I am confident reading more advanced books in English", confidence, fixed = TRUE) ~ 0,
    grepl("I am confident reading very complex information", confidence, fixed = TRUE) ~ 1,
    TRUE ~ NA
  ))
```

## ethcity
```{r}
dem_summer_clean <- dem_summer_clean%>%
  mutate(ethcity = case_when(
    grepl("South Asian,Pacific Islander,Mixed Race", ethcity, fixed = TRUE) ~ 0,
    grepl("Black or African American", ethcity, fixed = TRUE) ~ 1,
    grepl("Caucasian", ethcity, fixed = TRUE) ~ 2, 
    grepl("East or South East Asian", ethcity, fixed = TRUE) ~ 3,
    grepl("Hispanic or Latino", ethcity, fixed = TRUE) ~ 4,
    grepl("Middle Eastern or West Asian", ethcity, fixed = TRUE) ~ 5,
    grepl("Mixed Race", ethcity, fixed = TRUE) ~ 6,
    grepl("Native American",ethcity, fixed = TRUE) ~ 7,
    grepl("South Asian", ethcity, fixed = TRUE) ~ 8,
    TRUE~NA
  ))
```

## f_education
```{r}
dem_summer_clean <- dem_summer_clean %>%
  mutate(f_education = case_when(
    grepl("He left when he graduated from high school (or GED)", f_education, fixed = TRUE) ~ 1, 
    grepl("He left school before he graduated from high school", f_education, fixed = TRUE) ~ 2,
    grepl("He attended some college, but left before he earned a 4-year degree", f_education, fixed = TRUE) ~ 3,
    grepl("He earned a 4-year degree", f_education, fixed = TRUE) ~ 4,
    grepl("He earned a graduate degree (Masters or Ph.D)", f_education, fixed = TRUE) ~ 5,
    TRUE~NA
  ))
```

## m_education
```{r}
dem_summer_clean <- dem_summer_clean %>%
  mutate(m_education = case_when(
    grepl("She left school when she graduated from high school (or GED)", m_education, fixed = TRUE) ~ 1, 
    grepl("She left school before she graduated from high school", m_education, fixed = TRUE) ~ 2,
    grepl("She attended some college, but left before she earned a 4-year degree", m_education, fixed = TRUE) ~ 3,
    grepl("She earned a 4-year degree", m_education, fixed = TRUE) ~ 4,
    grepl("She earned a graduate degree (Masters or Ph.D)", m_education, fixed = TRUE) ~ 5,
    TRUE~NA
  ))
```


## lunch_program
```{r}
dem_summer_clean <- dem_summer_clean %>%
  mutate(lunch_program = case_when(
    grepl("I did not", lunch_program, fixed = TRUE) ~ 0,
    grepl("I don't know", lunch_program, fixed = TRUE) ~ 1,
    grepl("I qualified", lunch_program, fixed = TRUE) ~ 2,
    TRUE~NA
  ))
```


##Pell Grant

```{r}
dem_summer_clean <- dem_summer_clean %>%
  mutate(Grant = case_when(
    grepl("I do not qualify", Grant, fixed = TRUE) ~ 0,
    grepl("I do qualify", Grant, fixed = TRUE) ~ 1,
    grepl("I don't know", Grant, fixed = TRUE) ~ 2,
    TRUE~NA
  ))
```


## Transfer
```{r}
dem_summer_clean <- dem_summer_clean %>%
  mutate(Transfer = case_when(
    grepl("No", Transfer, fixed = TRUE) ~ 0,
    grepl("Yes", Transfer, fixed = TRUE) ~ 1,
    TRUE~NA
  ))
```

## first_gen
```{r}
dem_summer_clean <- dem_summer_clean %>% mutate(first_gen = case_when(f_education <4 & m_education < 4 ~ 1, f_education >= 4 | m_education >= 4 ~ 0))

dem_summer_clean <- dem_summer_clean %>%  mutate(first_gen = case_when(first_gen == NA & f_education < 4 | m_education < 4 ~ 1, .default = first_gen)) %>% mutate( first_gen = case_when(first_gen == NA & m_education < 4 | f_education < 4 ~ 1, .default = first_gen)) %>% mutate_at(c(1,4,5,6,7,8,9), factor) 
```

## save file
```{r}
write.csv(dem_summer_clean, file = "Pilot_dem_cleaned.csv", row.names = F)
```



```{r}
test <- read.csv("Pilot_dem_cleaned.csv")

test <- test %>% mutate_at(c(1,4, 5), factor)




table <- test %>% group_by(year) %>% summarise(n= n(), mean = mean(age))

hist(test$age)

```

##canvas
```{r}
setwd("~/Documents/GitHub/MC_data_cleaning/pilot data")
```

```{r}
data<- read.csv ("Pilot_canvas_data.csv")
```



```{r}
canvas_data <- data %>% select("SIS.User.ID", contains("Exam.1..892860."), contains("Exam.2..892861."), contains("Exam.3..892862."), contains("Exam.4..892863."), contains("Exam.5..892864."), contains("Final.Exam..892865."),"Prep.Participation..up.to.250.points..Final.Points", contains("Extra.Credit.Final.Points"), contains("Exam.Corrections")) %>% mutate_at(-c(1), as.numeric)
```

```{r}
colnames(canvas_data)<- c("SID", "exam1", "exam2", "exam3","exam4","exam5","final_exam", "prep_p_raw", "extra_credit", "e_correct")
```

## p_p_final
```{r}
canvas_data$p_p_final <- canvas_data$prep_p_raw
canvas_data$p_p_final[canvas_data$prep_p_raw >= 250]<- 250
```

## drop the lowest exam score
```{r}
canvas_data <- canvas_data %>% filter(!is.na(SID))
canvas_data[is.na(canvas_data)] <- 0
canvas_exam <- canvas_data %>% select(contains("exam"))
canvas_exam$lowest <- apply(canvas_exam, 1, min)
canvas_exam$lowest <- canvas_exam$lowest * -1
canvas_data$exam_total <- apply(canvas_exam, 1, sum)
```

```{r}
final_grade_calc <- canvas_data %>% select("extra_credit", "p_p_final", "exam_total")
canvas_clean <- canvas_data %>% 
  mutate(final_grade = apply(final_grade_calc, 1, sum)) %>%
  mutate(opt_in = case_when(e_correct == 0 ~ 0, e_correct > 0 ~ 1)) 
```


```{r}

exam_col <- canvas_clean %>% select(contains("exam"), -exam_total)
```

```{r}
canvas_final <- canvas_clean %>% mutate(exam_total = (exam_total/750)*100) %>% mutate(final_grade = (final_grade/1000)*100)
```


## write document
```{r}
write.csv(canvas_final, file = "Pilot_canvas_cleaned.csv", row.names = F)
```





Final_data <- left_join(dem_data, canvas, by = SID) # only fills in the data from canvas for SIDs that exist in the dem data set --- leaves out students who don't consent