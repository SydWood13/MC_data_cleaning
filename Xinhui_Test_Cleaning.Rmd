---
title: "CleaningTestScript"
author: "Sydney Wood"
date: "2024-06-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load Packages 
```{r}
library(tidycode)
library(tibble)
library(dplyr)
library(tidyverse)
setwd("~/Documents/GitHub/MC_data_cleaning")
```


## Demographic Cleaning

```{r}
dem_data_raw <- read.csv(file = "Raw_dem_data_anon.csv")
dem_data_short <- dem_data_raw %>% select("anon_id", "consent", contains(".."))

colnames(dem_data_short) <- c("anon_id", "consent", "age", "year", "gender", "int_student", "esl", "e_exp", "e_lvl", "URM", "p_education", "m_education", "par_rel", "fin_support", "ses", "grant", "soc_med", "hw_time", "transfer")
```

## Change the categorical data to factors
```{r}
#dem_data<- dem_data_short %>% mutate_at(c(2,4,5,6,7, 10,13,14,15,16,19), factor) 
```

## consent
```{r}
dem_data_clean <- dem_data_short %>%
  mutate(consent = case_when(
    grepl("I do not consent", consent, fixed = TRUE) ~ 0,
    grepl("I consent to participate", consent, fixed = TRUE) ~ 1,
    TRUE ~ 0))



dem_data_clean <- dem_data_clean %>%
  filter(consent == 1)
```


## there is a 2002 in age column.
## age
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(age = case_when(
     grepl("2,002", age, fixed = TRUE) ~ "21",
    TRUE ~ age)) %>% mutate_at(3,as.numeric) 
```
## year
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(year = case_when(
    grepl("Freshman", year, fixed = TRUE) ~ 1,
    grepl("Sophomore", year, fixed = TRUE) ~ 2,
    grepl("Junior", year, fixed = TRUE) ~ 3,
    grepl("Senior - 4th year", year, fixed = TRUE) ~ 4,
    grepl("Senior - 5th+ year", year, fixed = TRUE) ~ 5,
    TRUE~NA
  )) %>% mutate_at(4,factor)
```

## Gender
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(gender = case_when(
    grepl("Woman", gender, fixed = TRUE) ~ 'Woman',
    grepl("Man", gender, fixed = TRUE) ~ 'Man',
    grepl("Non-binary or Genderqueer", gender, fixed = TRUE) ~ 'Other',
    TRUE~NA
  )) %>% mutate_at(5, factor)
```

## int_student
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(int_student = case_when(
    grepl("Yes", int_student, fixed = TRUE) ~ 1,
    grepl("No", int_student, fixed = TRUE) ~ 0,
    TRUE~NA
  )) %>% mutate_at(6, factor)
```

## esl
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(esl = case_when(
    grepl("English is my first language", esl, fixed = TRUE) ~ 1,
    grepl("English is not my first language", esl, fixed = TRUE) ~ 0,
    TRUE~NA
  ))%>% mutate_at(7, factor)
```

##e_exp
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(e_exp = str_remove_all(e_exp, "%")
  )%>% mutate_at(8, as.numeric)
```


## e_lvl
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(e_lvl = case_when(
    grepl("0", e_lvl, fixed = TRUE) ~ 0,
    grepl("1", e_lvl, fixed = TRUE) ~ 1,
    grepl("2", e_lvl, fixed = TRUE) ~ 2,
    grepl("3", e_lvl, fixed = TRUE) ~ 3,
    grepl("4", e_lvl, fixed = TRUE) ~ 4,
    grepl("5", e_lvl, fixed = TRUE) ~ 5, 
    grepl("6", e_lvl, fixed = TRUE) ~ 6, 
    TRUE~NA
  ))%>% mutate_at(9, as.integer)
```

### URM
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(URM = case_when(
    grepl("Black or African American", URM, fixed = TRUE) ~ 1,
    grepl("Caucasian", URM, fixed = TRUE) ~ 2, 
    grepl("East or South East Asian", URM, fixed = TRUE) ~ 3,
    grepl("Hispanic or Latino", URM, fixed = TRUE) ~ 4,
    grepl("Middle Eastern or West Asian", URM, fixed = TRUE) ~ 5,
    grepl("Mixed Race", URM, fixed = TRUE) ~ 6,
    grepl("North or Central Asian",URM, fixed = TRUE) ~ 7,
    grepl("Pacific Islander", URM, fixed = TRUE) ~ 8,
    grepl("South Asian", URM, fixed = TRUE) ~ 9,
    TRUE~NA
  ))%>% mutate_at(10, factor)
```

### p_education
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(p_education = case_when(
    grepl("He never attended school", p_education, fixed = TRUE) ~ 1,
    grepl("He left when he graduated from high school (or GED)", p_education, fixed = TRUE) ~ 2, 
    grepl("He left school before he graduated from high school", p_education, fixed = TRUE) ~ 3,
    grepl("He attended some college, but left before he earned a 4-year degree", p_education, fixed = TRUE) ~ 4,
    grepl("He earned a 4-year degree", p_education, fixed = TRUE) ~ 5,
    grepl("He earned a graduate degree (Masters or Ph.D)", p_education, fixed = TRUE) ~ 6,
    TRUE~NA
  ))
```


### m_education
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(m_education = case_when(
    grepl("She never attended school", m_education, fixed = TRUE) ~ 1,
    grepl("She left when she graduated from high school (or GED)", m_education, fixed = TRUE) ~ 2, 
    grepl("She left school before she graduated from high school", m_education, fixed = TRUE) ~ 3,
    grepl("She attended some college, but left before she earned a 4-year degree", m_education, fixed = TRUE) ~ 4,
    grepl("She earned a 4-year degree", m_education, fixed = TRUE) ~ 5,
    grepl("She earned a graduate degree (Masters or Ph.D)", m_education, fixed = TRUE) ~ 6,
    TRUE~NA
  ))
```

##Get a new column first_gen by p_education and m_education
```{r}
dem_data_clean <- dem_data_clean %>% mutate(first_gen = case_when(p_education < 5 & m_education < 5 ~ 1, p_education >= 4 | m_education >= 4 ~ 0))

dem_data_clean <- dem_data_clean %>%  mutate(first_gen = case_when(first_gen == NA & p_education < 5 | m_education < 5 ~ 1, .default = first_gen)) %>% mutate( first_gen = case_when(first_gen == NA & m_education < 5 | p_education < 5 ~ 1, .default = first_gen)) %>% mutate_at(20, factor)
```

## par_rel
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(par_rel = case_when(
    grepl("Together", par_rel, fixed = TRUE) ~ "Together",
    grepl("Divorced", par_rel, fixed = TRUE) ~ "Divorced",
    grepl("Separated", par_rel, fixed = TRUE) ~ "Separated",
    grepl("Single", par_rel, fixed = TRUE) ~ "Single",
    TRUE~NA
  ))
```

##fin_support
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(fin_support = case_when(
    grepl("No support", fin_support, fixed = TRUE) ~ 1,
    grepl("Very little support", fin_support, fixed = TRUE) ~ 2,
    grepl("A little support",fin_support, fixed = TRUE) ~ 3,
    grepl("Some support", fin_support, fixed = TRUE) ~ 4,
    grepl("Halfway supported", fin_support, fixed = TRUE) ~ 5, 
    grepl("Mostly supported", fin_support, fixed = TRUE) ~ 6, 
    grepl("Fully supported", fin_support, fixed = TRUE) ~ 7,
    TRUE~NA
  ))
```

## ses
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(ses = case_when(
    grepl("I did not qualify for 'free or reduced cost lunch' at all in high school", ses, fixed = TRUE) ~ 0,
    grepl("I don't know if I qualified for a 'free or reduced cost lunch' program", ses, fixed = TRUE) ~ 1,
    grepl("I qualified for 'free or reduced cost lunch' for all or most of high school",ses, fixed = TRUE) ~ 2,
    grepl("I qualified for 'free or reduced cost lunch' for some of high school", ses, fixed = TRUE) ~ 3,
    TRUE~NA
  ))%>% mutate_at(15, factor)
```

## grant
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(grant = case_when(
    grepl("I do not qualify for a Pell Grant", grant, fixed = TRUE) ~ 0,
    grepl("I do qualify for a Pell Grant", grant, fixed = TRUE) ~ 1,
    grepl("I don't know if I qualify for a Pell Grant",grant, fixed = TRUE) ~ 2,
    TRUE~NA
  ))%>% mutate_at(16, factor)
```

## soc_med
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(soc_med = case_when(
    soc_med == 0 ~ NA, .default = soc_med
    ))%>%mutate(soc_med = str_remove_all(soc_med, ",")
  )%>% mutate_at(17, as.numeric)
```

## hw_time
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(hw_time = case_when(
    hw_time == 0 ~ NA, .default = hw_time
    ))%>% mutate(hw_time = str_remove_all(hw_time, ",")
  )%>% mutate_at(18, as.numeric)
```



## transfer
```{r}
dem_data_clean <- dem_data_clean %>%
  mutate(transfer = case_when(
    grepl("Yes", transfer, fixed = TRUE) ~ 1,
    grepl("No", transfer, fixed = TRUE) ~ 0,
    TRUE~NA
  ))%>% mutate_at(19, factor)
```

# save csv 
```{r}
write.csv(dem_data_clean, file = "First_dataset.csv")
```



## Overall Grade Data (canvas)

```{r}
cleaned <- read.csv(file = "wq_grade_data_cleaned_anon.csv")

raw <-  read.csv(file = "wq23_canvas_data_raw_anon.csv")

```


P+P (prep & Participation) --- Final score cannot be above 250 


There are 6 exams, but only 5 count toward the final grade. The "exam_total" the sum of  the 5 highest grades of the "exam" category turned in to a percentage (out of 750). 


while calculating the final column you will have columns for all the raw exam and raw_final_grade, but at the very end you will drop those 


For exams:  Turn each exam to % correct (all exams are out of 150) 


Extra Credit: Final Points & Exam.Correction... 

P+P - Final Points 


final grade calculation = p+p_final(upto 250) + raw_exam_total(upto 750, not percent, but only included the 5 highest exam grades) + extra_credit_total


After calculating turn final grade into % by divide by 1000 and then * 100 

### Canvas
```{r}
wq_grades <- read.csv(file = "wq23_canvas_data_raw_anon.csv")
wq_grades_short <- wq_grades %>% select("anon_id", "Exam.1..965996.", "Exam.2..965997.", "Exam.3..965998.", "Exam.4..965999.", "Exam.5..966000.", "Final.Exam..966002.", "Prep.Participation..up.to.250.points..Final.Points", "Extra.Credit.Final.Points", "Exam.Corrections...966001." ) %>% mutate_at(-c(1,2), as.numeric)

colnames(wq_grades_short) <- c("anon_id", "exam1", "exam2","exam3","exam4","exam5","exam6", "prep_p_raw", "extra_credit", "e_correct")

```

##p_p_final
```{r}
wq_grades_short$p_p_final <- wq_grades_short$prep_p_raw
wq_grades_short$p_p_final[wq_grades_short$prep_p_raw >= 250] <- 250
```


#drop the lowst exam score
```{r}
wq_exams <- wq_grades_short %>% select(contains("exam"))
wq_exams$lowest <- apply(wq_exams, 1, min)
wq_exams$lowest <- wq_exams$lowest * -1
wq_grades_short$exam_total <- apply(wq_exams, 1, sum)
```


```{r}
final_grade_calc <- wq_grades_short %>% select("extra_credit", "p_p_final", "exam_total")
wq_grades_clean <- wq_grades_short %>% 
  mutate(final_grade = apply(final_grade_calc, 1, sum)) %>%
  mutate(opt_in = case_when(e_correct == 0 ~ 0, e_correct > 0 ~ 1)) 
```

```{r}
wq_grades_clean <- wq_grades_clean %>% mutate_at(c(2:8),~na_if(.,0) )
exam_col <- wq_grades_clean %>% select(contains("exam"), -exam_total)
```

```{r}
div <- function(x) ((x/150) *100)

wq_grades_final <- wq_grades_clean %>% mutate_at(colnames(exam_col), div) %>% mutate(exam_total = (exam_total/750)*100) %>% mutate(final_grade = (final_grade/1000)*100)
```

#save file
```{r}
write.csv(wq_grades_final, file = "wq_grades_final.csv")
```

